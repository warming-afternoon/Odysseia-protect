# Bot 设计方案文档

本文档详细阐述了一个用于 Discord 帖子内进行文件资源管理的 Bot 的设计方案。该方案旨在通过自动化的命令和后台处理，极大地优化作者的发布体验和用户的下载体验。

## 核心设计思路

本方案提供两种资源上传和管理模式，以满足不同场景下的需求：

1.  **普通上传模式 (Normal Mode)**: 资源保留在当前帖子中，作者仅通过命令引用已发布的消息。Bot 负责聚合信息，提供一个便捷的浏览和下载界面，但不转存文件。
2.  **安全上传模式 (Secure Mode)**: 作者将文件直接上传给 Bot，Bot 将其存储在一个仅自己可见的私密“仓库频道”中。这种模式有效增加了爬虫获取资源的难度，并提供了密码保护等额外安全功能。

---

## 主要功能命令

### 1. `/上传` (作者使用)

*   **功能**: 允许帖子作者上传或登记一个新的资源版本。
*   **参数**:
    *   `模式`: 选择“普通模式”或“安全模式”。
    *   `文件` (仅安全模式): 上传资源文件。
    *   `消息链接` (仅普通模式): 粘贴帖子内已有的资源消息链接。
    *   `版本信息`: (必填) 为此资源添加版本号或描述 (例如: `v1.2 Final`, `2024-08-01 更新`)。
    *   `提取密码`: (可选, 仅安全模式) 为此资源版本设置一个下载密码。

### 2. `/下载` (用户使用)

*   **功能**: 在帖子内随时调用，获取当前帖子的所有资源列表并进行下载。
*   **交互流程**:
    1.  用户输入 `/下载` 命令。
    2.  Bot 返回一个复合的 `Embed` 消息。
    3.  该 `Embed` 包含一个版本选择下拉框，并清晰地展示所有可用的资源版本。
        *   下拉框每个菜单最多支持 25 个选项，通过分页逻辑支持超过 25 个版本的情况。
    4.  用户从下拉框中选择想要下载的版本。
    5.  如果资源有密码，Bot 会弹出要求输入密码的窗口。
    6.  验证通过后，Bot 会通过一条“仅自己可见”的消息或私信，将临时的、有时效性的下载链接发送给用户。

### 3. `/管理` (作者使用)

*   **功能**: 允许帖子作者通过一个可视化的 `Embed` 界面，对自己上传的所有资源版本进行增、删、改、查 (CRUD) 操作。
*   **同步性**: 对资源的任何修改（如更新版本信息、修改密码、删除版本）都会自动同步到数据库和后端的私密仓库频道，确保数据一致性。

---

## 后端实现流程 (安全模式示例)

1.  **上传**: 作者在帖子 A 中使用 `/上传` 命令，选择“安全模式”，并上传文件 `resource_v2.zip`。
2.  **开新帖**: Bot 接收到命令后，在私密的“仓库频道”中，为帖子 A 创建一个对应的私密仓库帖 A'。如果 A' 已存在，则直接使用。
3.  **存储**: Bot 将 `resource_v2.zip` 文件作为附件发送到仓库帖 A' 中，并将包含版本信息、密码、作者ID、源文件在 A' 中的消息ID 等数据存入数据库。
4.  **下载请求**: 用户在帖子 A 中使用 `/下载` 命令。
5.  **提供列表**: Bot 从数据库查询所有与帖子 A 关联的资源，并生成一个包含版本下拉框的 `Embed`。
6.  **选择版本**: 用户选择了 `resource_v2.zip` 对应的版本。
7.  **获取链接**: Bot 根据数据库记录，找到仓库帖 A' 中存储该文件的具体消息，并获取附件的临时下载 URL。
8.  **发送链接**: Bot 将此 URL 通过私密消息发送给用户。
9.  **用户下载**: 用户通过该 URL 直接从 Discord 下载文件。

---

## 技术方案讨论 (FAQ)

*   **问: 为什么不使用一个固定的、带按钮的“发卡面板”消息，而是用 `/下载` 命令？**
    *   **答**: Discord 的按钮组件存在一个体验缺陷。如果包含按钮的消息离当前聊天窗口的最新消息很远（即需要向上滚动很多才能看到），用户点击按钮后，Bot 发送的“仅自己可见”的私密消息有很高的概率会丢失或不显示。而使用斜杠命令 (`/下载`) 可以确保 Bot 的回应始终是最新消息，从而避免此问题，并且用户无需费力寻找面板，输入命令更直接。

*   **问: 可能的技术难点有哪些？**
    *   **答**: 核心难点在于**数据同步**。由于文件实体存储在 Discord 的仓库频道，而元数据存储在我们的数据库中，如果 Bot 服务器在处理过程中（例如，文件已上传但数据库写入失败）发生宕机或重启，可能会导致数据不一致。这需要通过严谨的事务处理和错误恢复机制来缓解。

---

## 本方案的优势

### 对比传统手动编辑

*   **作者便利性**:
    *   无需反复编辑首楼来更新资源链接列表。
    *   通过简单的右键菜单应用或 `/上传` 命令即可发布新版本。
*   **用户便利性**:
    *   无需为了找资源而手动滚动到帖子顶部或在楼层中翻找。
    *   随时随地使用 `/下载` 命令即可获得一个清晰、完整的资源导航页。

### 安全性

*   **安全模式**通过将资源存储在私密频道，并由 Bot 中转提供临时链接，极大地提升了反爬虫能力。相比于直接将文件链接暴露在公开帖子中，这种方式更为安全可控。

---

## 方案总结

| 特性         | 普通上传模式                  | 安全上传模式                       |
| :----------- | :---------------------------- | :--------------------------------- |
| **资源位置** | 保留在原始公开帖子中          | 存储在私密的仓库频道中             |
| **Bot 作用** | 提供更好的浏览/下载界面和命令 | 完全接管资源的存储、管理和分发     |
| **核心优势** | 便捷，对现有发布流程改动小    | 便捷、反爬虫、可设置密码、安全性高 |
